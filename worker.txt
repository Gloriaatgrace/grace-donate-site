export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    
    if (url.pathname === "/.well-known/apple-developer-merchantid-domain-association") {
      const GITHUB_URL = "https://raw.githubusercontent.com/Gloriaatgrace/grace-donate-site/main/.well-known/apple-developer-merchantid-domain-association";
      
      try {
        // Fetch from GitHub
        const githubResponse = await fetch(GITHUB_URL);
        
        if (!githubResponse.ok) {
          return new Response("Failed to fetch verification file", { 
            status: 502 
          });
        }
        
        // Get the text content
        const content = await githubResponse.text();
        
        // Return with correct headers - CRITICAL FOR APPLE
        return new Response(content, {
          status: 200,
          headers: {
            "Content-Type": "text/plain; charset=utf-8",  // Added charset
            "Cache-Control": "public, max-age=86400",
            "X-Robots-Tag": "noindex"
          }
        });
        
      } catch (error) {
        console.error('Error fetching Apple verification:', error);
        return new Response("Error fetching verification file", { 
          status: 502 
        });
      }
    }
    
    // Pass all other requests to origin (Squarespace)
    return fetch(request);
  }
};
